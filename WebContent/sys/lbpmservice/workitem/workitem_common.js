/*初始化默认意见*/
var defaultUsageContent_refuse = "";
var defaultUsageContent_commission = "";
var defaultUsageContent_communicate = "";
var defaultUsageContent_abandon = "";
var defaultUsageContent_superRefuse = "";
var defaultUsageContent_sign = "";
var defaultUsageContent_additionSign = "";
var defaultUsageContent_assign = "";
var defaultUsageContent_assignPass = "";
var defaultUsageContent_assignRefuse = "";
var defaultUsageContent_jump = "";
var defaultUsageContent_nodeSuspend = "";
var defaultUsageContent_nodeResume = "";

var isPassContentRequired = "false";
var isRefuseContentRequired = "true";
var isCommissionContentRequired = "false";
var isCommunicateContentRequired = "true";
var isAbandonContentRequired = "true";
var isSuperRefuseContentRequired = "true";
var isSignContentRequired = "true";
var isAdditionSignContentRequired = "false";
var isAssignContentRequired = "false";
var isAssignPassContentRequired = "false";
var isAssignRefuseContentRequired = "false";
var isJumpContentRequired = "false";
var isNodeSuspendContentRequired = "false";
var isNodeResumeContentRequired = "false";
var isReturnCommunicateContentRequired = "true";

var data = new KMSSData();
data.AddBeanData("lbpmUsageContentService");
data = data.GetHashMapArray();
if(data.length>0){
	if(data[0].defaultUsageContent!=null){
		defaultUsageContent = unescape(data[0].defaultUsageContent);
	}
	if(data[0].defaultUsageContent_refuse!=null){
		defaultUsageContent_refuse = unescape(data[0].defaultUsageContent_refuse);
	}
	if(data[0].defaultUsageContent_commission!=null){
		defaultUsageContent_commission = unescape(data[0].defaultUsageContent_commission);
	}
	if(data[0].defaultUsageContent_communicate!=null){
		defaultUsageContent_communicate = unescape(data[0].defaultUsageContent_communicate);
	}
	if(data[0].defaultUsageContent_abandon!=null){
		defaultUsageContent_abandon = unescape(data[0].defaultUsageContent_abandon);
	}
	if(data[0].defaultUsageContent_superRefuse!=null){
		defaultUsageContent_superRefuse = unescape(data[0].defaultUsageContent_superRefuse);
	}
	if(data[0].defaultUsageContent_sign!=null){
		defaultUsageContent_sign = unescape(data[0].defaultUsageContent_sign);
	}
	if(data[0].defaultUsageContent_additionSign!=null){
		defaultUsageContent_additionSign = unescape(data[0].defaultUsageContent_additionSign);
	}
	if(data[0].defaultUsageContent_assign!=null){
		defaultUsageContent_assign = unescape(data[0].defaultUsageContent_assign);
	}
	if(data[0].defaultUsageContent_assignPass!=null){
		defaultUsageContent_assignPass = unescape(data[0].defaultUsageContent_assignPass);
	}
	if(data[0].defaultUsageContent_assignRefuse!=null){
		defaultUsageContent_assignRefuse = unescape(data[0].defaultUsageContent_assignRefuse);
	}
	if(data[0].defaultUsageContent_jump!=null){
		defaultUsageContent_jump = unescape(data[0].defaultUsageContent_jump);
	}
	if(data[0].defaultUsageContent_nodeSuspend!=null){
		defaultUsageContent_nodeSuspend = unescape(data[0].defaultUsageContent_nodeSuspend);
	}
	if(data[0].defaultUsageContent_nodeResume!=null){
		defaultUsageContent_nodeResume = unescape(data[0].defaultUsageContent_nodeResume);
	}
	if(data[0].isPassContentRequired!=null){
		isPassContentRequired = data[0].isPassContentRequired;
	}
	if(data[0].isRefuseContentRequired!=null){
		isRefuseContentRequired = data[0].isRefuseContentRequired;
	}
	if(data[0].isCommissionContentRequired!=null){
		isCommissionContentRequired = data[0].isCommissionContentRequired;
	}
	if(data[0].isCommunicateContentRequired!=null){
		isCommunicateContentRequired = data[0].isCommunicateContentRequired;
	}
	if(data[0].isAbandonContentRequired!=null){
		isAbandonContentRequired = data[0].isAbandonContentRequired;
	}
	if(data[0].isSuperRefuseContentRequired!=null){
		isSuperRefuseContentRequired = data[0].isSuperRefuseContentRequired;
	}
	if(data[0].isSignContentRequired!=null){
		isSignContentRequired = data[0].isSignContentRequired;
	}
	if(data[0].isAdditionSignContentRequired!=null){
		isAdditionSignContentRequired = data[0].isAdditionSignContentRequired;
	}
	if(data[0].isAssignContentRequired!=null){
		isAssignContentRequired = data[0].isAssignContentRequired;
	}
	if(data[0].isAssignPassContentRequired!=null){
		isAssignPassContentRequired = data[0].isAssignPassContentRequired;
	}
	if(data[0].isAssignRefuseContentRequired!=null){
		isAssignRefuseContentRequired = data[0].isAssignRefuseContentRequired;
	}
	if(data[0].isJumpContentRequired!=null){
		isJumpContentRequired = data[0].isJumpContentRequired;
	}
	if(data[0].isNodeSuspendContentRequired!=null){
		isNodeSuspendContentRequired = data[0].isNodeSuspendContentRequired;
	}
	if(data[0].isNodeResumeContentRequired!=null){
		isNodeResumeContentRequired = data[0].isNodeResumeContentRequired;
	}
}
lbpm.workitem.constant.COMMONHANDLERUSAGECONTENTDEFAULT=new Array();
lbpm.workitem.constant.COMMONHANDLERUSAGECONTENTDEFAULT["handler_pass"] = defaultUsageContent;
lbpm.workitem.constant.COMMONHANDLERUSAGECONTENTDEFAULT["handler_refuse"] = defaultUsageContent_refuse;
lbpm.workitem.constant.COMMONHANDLERUSAGECONTENTDEFAULT["handler_commission"] = defaultUsageContent_commission;
lbpm.workitem.constant.COMMONHANDLERUSAGECONTENTDEFAULT["handler_communicate"] = defaultUsageContent_communicate;
lbpm.workitem.constant.COMMONHANDLERUSAGECONTENTDEFAULT["handler_abandon"] = defaultUsageContent_abandon;
lbpm.workitem.constant.COMMONHANDLERUSAGECONTENTDEFAULT["handler_superRefuse"] = defaultUsageContent_superRefuse;
lbpm.workitem.constant.COMMONHANDLERUSAGECONTENTDEFAULT["handler_sign"] = defaultUsageContent_sign;
lbpm.workitem.constant.COMMONHANDLERUSAGECONTENTDEFAULT["handler_additionSign"] = defaultUsageContent_additionSign;
lbpm.workitem.constant.COMMONHANDLERUSAGECONTENTDEFAULT["handler_assign"] = defaultUsageContent_assign;
lbpm.workitem.constant.COMMONHANDLERUSAGECONTENTDEFAULT["handler_assignPass"] = defaultUsageContent_assignPass;
lbpm.workitem.constant.COMMONHANDLERUSAGECONTENTDEFAULT["handler_assignRefuse"] = defaultUsageContent_assignRefuse;
lbpm.workitem.constant.COMMONHANDLERUSAGECONTENTDEFAULT["handler_jump"] = defaultUsageContent_jump;
lbpm.workitem.constant.COMMONHANDLERUSAGECONTENTDEFAULT["handler_nodeSuspend"] = defaultUsageContent_nodeSuspend;
lbpm.workitem.constant.COMMONHANDLERUSAGECONTENTDEFAULT["handler_nodeResume"] = defaultUsageContent_nodeResume;
lbpm.workitem.constant.COMMONHANDLERUSAGECONTENTDEFAULT_ISREQUIRED=new Array();
lbpm.workitem.constant.COMMONHANDLERUSAGECONTENTDEFAULT_ISREQUIRED["handler_pass"] = isPassContentRequired;
lbpm.workitem.constant.COMMONHANDLERUSAGECONTENTDEFAULT_ISREQUIRED["handler_refuse"] = isRefuseContentRequired;
lbpm.workitem.constant.COMMONHANDLERUSAGECONTENTDEFAULT_ISREQUIRED["handler_commission"] = isCommissionContentRequired;
lbpm.workitem.constant.COMMONHANDLERUSAGECONTENTDEFAULT_ISREQUIRED["handler_communicate"] = isCommunicateContentRequired;
lbpm.workitem.constant.COMMONHANDLERUSAGECONTENTDEFAULT_ISREQUIRED["handler_cancelCommunicate"] = isCommunicateContentRequired;
lbpm.workitem.constant.COMMONHANDLERUSAGECONTENTDEFAULT_ISREQUIRED["handler_abandon"] = isAbandonContentRequired;
lbpm.workitem.constant.COMMONHANDLERUSAGECONTENTDEFAULT_ISREQUIRED["handler_superRefuse"] = isSuperRefuseContentRequired;
lbpm.workitem.constant.COMMONHANDLERUSAGECONTENTDEFAULT_ISREQUIRED["handler_sign"] = isSignContentRequired;
lbpm.workitem.constant.COMMONHANDLERUSAGECONTENTDEFAULT_ISREQUIRED["handler_additionSign"] = isAdditionSignContentRequired;
lbpm.workitem.constant.COMMONHANDLERUSAGECONTENTDEFAULT_ISREQUIRED["handler_assign"] = isAssignContentRequired;
lbpm.workitem.constant.COMMONHANDLERUSAGECONTENTDEFAULT_ISREQUIRED["handler_assignPass"] = isAssignPassContentRequired;
lbpm.workitem.constant.COMMONHANDLERUSAGECONTENTDEFAULT_ISREQUIRED["handler_assignRefuse"] = isAssignRefuseContentRequired;
lbpm.workitem.constant.COMMONHANDLERUSAGECONTENTDEFAULT_ISREQUIRED["handler_jump"] = isJumpContentRequired;
lbpm.workitem.constant.COMMONHANDLERUSAGECONTENTDEFAULT_ISREQUIRED["handler_nodeSuspend"] = isNodeSuspendContentRequired;
lbpm.workitem.constant.COMMONHANDLERUSAGECONTENTDEFAULT_ISREQUIRED["handler_nodeResume"] = isNodeResumeContentRequired;
lbpm.workitem.constant.COMMONHANDLERUSAGECONTENTDEFAULT_ISREQUIRED["handler_returnCommunicate"] = isReturnCommunicateContentRequired;
lbpm.workitem.constant.COMMONHANDLERUSAGECONTENTDEFAULT_ISREQUIRED["drafter_abandon"] = "true";
/*初始化默认意见*/
var nodeOprLangs={};
//创建操作栏
lbpm.globals.createOperationMethodGroups=function(){
	function _getLangLabel(defLabel,langsArr,lang){
		if(langsArr==null){
			return defLabel;
		}
		for(var i=0;i<langsArr.length;i++){
			if(lang==langsArr[i]["lang"]){
				return langsArr[i]["value"]||defLabel;
			}
		}
		return defLabel;
	}

var countWorkItemDownList = [];
/**
 * 定时任务倒计时
 * @param op
 * @param milliseconds
 * @returns
 */
function countWorkItemDown(op,milliseconds){
	var countDownHtml=lbpm.globals.countDownHtml(milliseconds);
	document.getElementById(op).innerHTML=countDownHtml;
	var countWorkItemDownHander =setTimeout(function () { countWorkItemDown(op,milliseconds); },1000);
	countWorkItemDownList.push(countWorkItemDownHander);
}

/**
 * 清理定时任务
 * @param list
 * @returns
 */
function learTimeoutList (list) {
	$.each(list,function(n,value) { 
		window.clearTimeout(value);
	});
}

/**
 * 初始化div
 * @param button
 * @returns
 */
function buttonWorkItemPressTimeInit(button,opId){
	var pressTimes=lbpm.globals.ajaxPressTime(opId);
	var $tipElement = $("<div class='drafterPressTimeTip' id='informWorkItem"+opId+"' style='display:none; z-index:9999;width:170px;height:20px;border-radius:4px;padding:4px 6px 4px 6px;text-align:center;position:absolute;left:-8px;top:26px;background-color: #D8D8D8; color:#4285f4;'></div>");
	$(button).parent('.lui-lbpm-radio').append($tipElement);
	$(button).parent('.lui-lbpm-radio').css("position","relative");
	$(button).parent('.lui-lbpm-radio').bind("mouseover",function(){
		var pressTimesTemp=lbpm.globals.ajaxPressTime(opId);//绑定的这个悬浮事件去访问
		
		if(pressTimesTemp>0){
			$(button).attr("disabled",true);
			countWorkItemDown('informWorkItem'+opId,pressTimesTemp);
			$tipElement.show();
		}else{
			$(button).attr("disabled",false);
		}
	});
	$(button).parent('.lui-lbpm-radio').bind("mouseout",function(){
		learTimeoutList(countWorkItemDownList);
		$tipElement.hide();
	});
	
	if(pressTimes>0){
		$(button).attr("disabled",true);
		curWorkItemPressCount=(lbpm.globals.remainMilliseconds(pressTimes)/1000);
		restoreWorkItemClick=button;
		InterWorkItemPressValObj = window.setInterval(setWorkItemPressRemainTime, 1000); //启动计时器，1秒执行一次
	}
}

var InterWorkItemPressValObj; //timer变量，控制时间
var curWorkItemPressCount;//当前剩余秒数
var restoreWorkItemClick=null;//需要恢复的按钮

//timer处理函数，恢复按钮
function setWorkItemPressRemainTime() {
	if (curWorkItemPressCount <= 0) {      
	    window.clearInterval(InterWorkItemPressValObj);//停止计时器
	    $(restoreWorkItemClick).attr("disabled",false);
	}
	else {
		curWorkItemPressCount--;
	}
}

	var operMethodsGroup = $("#operationMethodsGroup");
	if (operMethodsGroup.length == 0) {
		return;
	}
	var vtype = operMethodsGroup.attr('view-type');
	var operatorInfo = lbpm.globals.analysisProcessorInfoToObject();
	

	if(_isLangSuportEnabled){
		var currNodeInfo = lbpm.globals.getCurrentNodeObj();
		if(currNodeInfo.operations && currNodeInfo.operations.refId != null){//操作引用
			var data = new KMSSData();
			data.AddBeanData("getOperationsByDefinitionService&fdId="+currNodeInfo.operations.refId);
			data = data.GetHashMapArray();
			if (data.length > 0) {
				var operations = data[0].operation;
				operations = $.parseJSON(operations);
				for(var i=0; i<operations.length; i++){
					if(typeof operations[i].langs!="undefined"){
						nodeOprLangs[operations[i].type+"-"+operations[i].name]=$.parseJSON(operations[i].langs);
					}
				}
			}
		}else{//操作自定义
			if(typeof currNodeInfo.langs!="undefined"){
				if(currNodeInfo.langs!=""){
					var langsJson = $.parseJSON(currNodeInfo.langs);
					nodeOprLangs = langsJson.nodeOpr||{};
				}
			}
		}
	}
	
	var view = vtype == 'select' ? (function(oprValue, oprName, oprItem, operInfo) {
		var langs = nodeOprLangs[oprValue];
		if(typeof langs=="undefined"){
			langs = nodeOprLangs[oprValue+"-"+oprName];
		}
		if(typeof langs!="undefined"){
			oprName = _getLangLabel(oprName,langs,_userLang);
		}

		var optionHtml = "<option value='" + oprValue + ":" + oprName + "' ";
		if(oprValue == lbpm.defaultOperationType){
			optionHtml += "selected='true' ";
		}
		optionHtml += ">" + oprName + "</option>";
		return optionHtml;
	}) : (function(oprValue, oprName, oprItem, operInfo) {

		var langs = nodeOprLangs[oprValue];
		if(typeof langs=="undefined"){
			langs = nodeOprLangs[oprValue+"-"+oprName];
		}
		if(typeof langs!="undefined"){
			oprName = _getLangLabel(oprName,langs,_userLang);
		}
		
		var radioButtonHTML = "<nobr><label style='padding-right:5px;' class='lui-lbpm-radio'>"
				+"<input type='radio' alertText='' key='operationType' name='oprGroup' value='" + oprValue + ":" + oprName + "' ";
		
		
		//#53782 流程管理模块中发起沟通后，被沟通人在进入流程后，页面默认勾选回复沟通按钮 by 李文昌
		if(oprValue == lbpm.defaultOperationType || oprValue === "handler_returnCommunicate"){
			radioButtonHTML += "checked='true' ";
		}
		radioButtonHTML += " onclick='lbpm.globals.clickOperation(this);'><span class='radio-label'>" + oprName + "</span></label></nobr>";
		radioButtonHTML += " "; // 避免不能换行
		return radioButtonHTML;
	});
	var notify = vtype == 'select' ? (function() {
		$("#operationMethodsGroup").change(function() {
			lbpm.globals.clickOperation(this);
		});
		$("#operationMethodsGroup  option").each(function(){
			var item=this;
			var opt = lbpm.operations[item.value.split(':')[0]];
			if (opt && opt.isPassType) {
				$(item).attr('selected', true);
				return false;
			}
		});
		lbpm.globals.clickOperation($("#operationMethodsGroup")[0].value);
	}) : (function() {
		var radio = $("#operationMethodsGroup input[name='oprGroup']");
		if (radio.length == 1) {
			radio.attr('disabled', false);
			radio.attr('checked', true);
			radio.attr('onclick', 'return;');
			
			//#29894 当操作人（起草人或审批人或者分支特权人）操作仅有一项时，隐藏整行 by wubing
			var opinfo = radio.val();
			var opvalue = opinfo.split(":")[0];
			if(opvalue=="drafter_submit"
				||opvalue=="handler_pass"
				||opvalue=="handler_sign"
					|| (opvalue=='branchadmin_startconcurrentbranch' && lbpm.approveType != 'right')){
					var operationMethodsRow = $("#operationMethodsRow");
					lbpm.globals.hiddenObject(operationMethodsRow, true);
			}

		}else if(radio.length > 1){
			if (lbpm.constant.ROLETYPE != lbpm.constant.HISTORYHANDLERROLETYPE) {
				var operationMethodsRow = $("#operationMethodsRow");
				lbpm.globals.hiddenObject(operationMethodsRow, false);
			}
		}
		if (radio.length == 0) {
			return;
		}
		radio.each(function() {
			var thisRadio = this;
			
			var optType=thisRadio.value.split(':')[0];
			
			if(optType=="drafter_press"||optType=="history_handler_press"){
				var taskId="";
				if(optType=="drafter_press"){
					taskId=lbpm.drafterInfoObj[0].id;
				}else if(optType=="history_handler_press"){
					taskId=lbpm.historyhandlerInfoObj[0].id;
				}
				buttonWorkItemPressTimeInit(thisRadio,taskId);
			}
			
			
			if (this.checked) {
				lbpm.globals.clickOperation(thisRadio);
				return false;
			}
			var opt = lbpm.operations[thisRadio.value.split(':')[0]];
				
			if (opt && opt.isPassType) {
				$(thisRadio).attr('checked', true);
				lbpm.globals.clickOperation(thisRadio);
				return false;
			}
		});
	});
	var html = '';
	$.each(operatorInfo.operations, function(i, item) {
		html += view(item.id, Com_HtmlEscape(item.name), item, operatorInfo);
	});
	// 当前工作项是微审批工作项时在操作栏处提示用户进行扫码分享审批
	if(lbpm.nowProcessorInfoObj && lbpm.nowProcessorInfoObj.type=="shareReviewWorkitem"){
		html += "<nobr><label style='padding-right:5px;color: #ff0000;'>" + "(请点击右侧分享按钮，使用微信扫码，将流程分享给外部审批人，完成审批)" + "</label></nobr>";
	}
	operMethodsGroup.html(html);
	notify();
	if (typeof createOpr != 'undefined'){
		createOpr();
	}
};

//流程暂存
lbpm.globals.saveDraftAction=function(btn) {
	var operatorInfo = lbpm.nowProcessorInfoObj;
	if(!operatorInfo) {
		return;
	}
	var fdUsageContent=lbpm.operations.getfdUsageContent();
	if(!fdUsageContent) {
		return;
	}
	//意见长度检查
	if(fdUsageContent.value != "") {
		var maxLength = 4000;
		if (fdUsageContent.value.length > maxLength) {
			//新增审批意见长度判断
			var msg = lbpm.constant.ERRORMAXLENGTH;
			var title = lbpm.constant.CREATEDRAFTCOMMONUSAGES;
			msg = msg.replace(/\{0\}/, title).replace(/\{1\}/, maxLength);
			//alert(msg);
			return ;
		}
	} else {
		//alert(lbpm.workitem.constant.COMMONUSAGECONTENTNOTNULL);
		return ;
	}
	if (btn)
		btn.disabled = true;
	try {
		var url = Com_Parameter.ContextPath + 'sys/lbpmservice/support/lbpm_process/lbpmProcess.do?method=saveDraft&ajax=true';
		var kmssData = new KMSSData();
		var obj = {};
		obj["taskId"] = lbpm.globals.getOperationParameterJson("id");
		obj["processId"] = $("[name='sysWfBusinessForm.fdProcessId']")[0].value;
		obj["auditNote"] = fdUsageContent.value;
		obj["auditNoteFdId"] = $("input[name='sysWfBusinessForm.fdAuditNoteFdId']").val();
		if(lbpm.noticeHandlers){
			//处理格式上传
			var noticeHandlers = "";
			for(var i=0; i<lbpm.noticeHandlers.length; i++){
				var handler = lbpm.noticeHandlers[i];
				noticeHandlers += handler.id + ";";
				noticeHandlers += handler.name + ";";
				noticeHandlers += handler.startPos + ";";
				if(i == lbpm.noticeHandlers.length-1){
					noticeHandlers += handler.endPos;
				}else{
					noticeHandlers += handler.endPos + "|";
				}
			}
			obj["noticeHandlers"] = noticeHandlers;
		}
		kmssData.AddHashMap(obj);
		kmssData.SendToUrl(url, function(http_request) {
			if (btn) {
				btn.disabled = false;
				alert(http_request.responseText);
			}
		});
	} catch(e) {
		throw e;
		if (btn)
			btn.disabled = false;
	}
};

//@处理人
lbpm.globals.selectHistoryHandlers = function(btn,tagName){
	if(!tagName){
		return;
	}
	var processId = lbpm.modelId;
	var action = function(rtnData){
		var handlers = rtnData.GetHashMapArray();
		//var fdUsageContent = lbpm.operations.getfdUsageContent();
		var fdUsageContent = $("textarea[name='"+tagName+"']")[0];
		var content = fdUsageContent.value;
		if(handlers){
			var handlerObjs = [];
			var text = "";
			var pos;
			if (document.selection) {//IE
				fdUsageContent.focus();
				var sel = document.selection.createRange();
				sel.moveStart('character', -content.length); // 移动开始点到最左边位置
				pos = sel.text.length; 
			}else{
				pos = fdUsageContent.selectionStart;
			}
			lbpm.globals.changeNoticeHandlerToStr(pos);
			for(var i=0; i<handlers.length; i++){
				var handlerObj = {};
				var handler = handlers[i];
				var name = handler.name;
				var startPos = pos + text.length;
				var endPos = startPos + name.length + 3;
				handler.startPos = startPos;
				handler.endPos = endPos;
				var space = ToCDB(" ");
				text += space + "@"+name+space;
				
				handlerObj.id = handler.id;
				handlerObj.name = handler.name;
				handlerObj.startPos = startPos;
				handlerObj.endPos = endPos;
				handlerObjs.push(handlerObj);
			}
			var leftStr = fdUsageContent.value.substring(0,pos);
			var rightStr = fdUsageContent.value.substring(pos);
			fdUsageContent.value = leftStr + text + rightStr;
			lbpm.noticeAuditNote = fdUsageContent.value;
			if(fdUsageContent.createTextRange){//IE
				var range = fdUsageContent.createTextRange();  // 创建选定区
		        range.collapse(true);                // 设置为折叠,即光标起点和结束点重叠在一起
		        range.moveEnd('character', text.length+pos);     // 移动结束点
		        range.moveStart('character', text.length+pos);   // 移动开始点
		        range.select();      
			}else{
				fdUsageContent.setSelectionRange(text.length+pos,text.length+pos);
			}
			fdUsageContent.focus();
			//更新已经存在的处理人的位置
			lbpm.globals.updatenoticeHandlerPos(pos+text.length, text.length);
			//更新所有的处理人
			lbpm.globals.updatenoticeHandlers();
			//更新选择人数
			lbpm.globals.updatenoticeHandlerNum(handlerObjs);
			//更新选择总数
			lbpm.globals.updatenoticeHandlerTotal();
		}
	}
	Dialog_AddressList(true,null,null,';','noticeHistoryHandlersService&processId='+processId,
			action,'noticeHistoryHandlersService&processId='+processId+'&keyword=!{keyword}',null,null,"通知以下已处理人阅读");
}

//清空处理人的内容
lbpm.globals.emptyNoticeHandlerInfo = function(){
	lbpm.noticeAuditNote = "";
	lbpm.noticeHanlerNum = 0;
	lbpm.noticeHandlers = [];
	$('span.noticeHandlerNum').text(lbpm.noticeHanlerNum);
}

//获取处理人暂存的信息
lbpm.globals.initNoticeHandlersDataAction=function() {
	try {
		var url = Com_Parameter.ContextPath + 'sys/lbpmservice/support/lbpm_process/lbpmProcess.do?method=getNoticeHandlers&ajax=true';
		var kmssData = new KMSSData();
		var obj = {};
		obj["processId"] = $("[name='sysWfBusinessForm.fdProcessId']")[0].value;
		obj["taskId"] = lbpm.globals.getOperationParameterJson("id");
		kmssData.AddHashMap(obj);
		kmssData.SendToUrl(url, function(http_request) {
			var handlers = http_request.responseText;
			if(handlers){
				handlers = handlers.split("|");
				var noticeHandlers = [];
				for(var i=0; i<handlers.length; i++){
					var noticeHandler = {};
					var handler = handlers[i];
					if(handler){
						var elems = handler.split(";");
						if(elems.length >= 4){
							noticeHandler.id = elems[0];
							noticeHandler.name = elems[1];
							noticeHandler.startPos = parseInt(elems[2]);
							noticeHandler.endPos = parseInt(elems[3]);
							noticeHandlers.push(noticeHandler);
						}
					}
				}
				lbpm.globals.updatenoticeHandlerNum(noticeHandlers);
			}
		});
	} catch(e) {
		throw e;
	}
};

//提交前匹配和去重处理
lbpm.globals.filterNoticeHandler = function(){
	if(lbpm.noticeHandlers){
		var fdUsageContent = lbpm.operations.getfdUsageContent();
		var content = fdUsageContent.value;
		//var noticeHandlerIds = [];
		var noticeHandlerIdStr = "";
		for(var i=0; i<lbpm.noticeHandlers.length; i++){
			var handler = lbpm.noticeHandlers[i];
			var startPos = handler.startPos;
			var endPos = handler.endPos;
			var text = content.substring(startPos, endPos);
			if(/\s@\S+\s/.test(text)){
				if(noticeHandlerIdStr.indexOf(handler.id) == -1){
					//noticeHandlerIds.push(handler.id);
					noticeHandlerIdStr += handler.id + ";";
				}
			}
		}
		$("input[name='noticeHandlerIds']").val(noticeHandlerIdStr);
		return noticeHandlerIdStr;
	}
	return null;
}

//根据位置删除处理人
lbpm.globals.delNoticeHandler = function(target,delStartPos, delEndPos, delContent){
	if(!target){
		return;
	}
	var fdUsageContent = target;
	var content = fdUsageContent.value;
	if(lbpm.noticeHandlers){
		var isDel = false;
		var rangeStartPos;
		var rangeEndPos;
		var delHandlersIndex = [];
		//补充删除的内容，保证逻辑的正常
		if(delEndPos){
			content = lbpm.noticeAuditNote.substring(0, delStartPos) + delContent + lbpm.noticeAuditNote.substring(delEndPos);
		}else{
			content = lbpm.noticeAuditNote.substring(0, delStartPos) + delContent + lbpm.noticeAuditNote.substring(delStartPos+1);
		}
		for(var i=0; i<lbpm.noticeHandlers.length; i++){
			var handler = lbpm.noticeHandlers[i];
			var startPos = handler.startPos;
			var endPos = handler.endPos;
			var name = handler.name;
			var id = handler.id;
			if(delEndPos){//删除选中
				if((delStartPos > startPos && delStartPos <= endPos) || (delEndPos > startPos && delEndPos <= endPos) || (
							delStartPos <= startPos && delEndPos >= endPos) || (delStartPos > startPos && delEndPos <= endPos)){
					//符合条件，删除处理人
					isDel = true;
					//lbpm.noticeHandlers.splice(i, 1);//删除处理人
					delHandlersIndex.push(i+'');
					//更新选中人数
					var isExit = false;
					for(var j=0; j<lbpm.noticeHandlers.length; j++){
						if(delHandlersIndex.indexOf(j+'') != -1){
							//说明已经被标记为删除，跳过
							continue;
						}
						if(i != j && lbpm.noticeHandlers[j].id === id){
							//存在
							isExit = true;
							break;
						}
					}
					if(!isExit){
						lbpm.noticeHanlerNum -= 1;
						$('#noticeHandlerNum').text(lbpm.noticeHanlerNum);
					}
				}
				if((rangeStartPos != 0 && !rangeStartPos) && (delStartPos > startPos && delStartPos <= endPos) || (delStartPos > startPos && delEndPos <= endPos)){
					rangeStartPos = startPos;
				}
				if((rangeEndPos != 0 && !rangeEndPos) && (delEndPos > startPos && delEndPos <= endPos) || (delStartPos > startPos && delEndPos <= endPos)){
					rangeEndPos = endPos;
				}
			}else{//删除一个
				if(delStartPos >= startPos && delStartPos < endPos){
					//符合条件，删除处理人
					isDel = true;
					var leftStr = content.substring(0, startPos);
					var rightStr = content.substring(endPos);
					fdUsageContent.value = leftStr + rightStr;
					lbpm.noticeAuditNote = leftStr + rightStr;
					lbpm.noticeHandlers.splice(i, 1);//删除处理人
					lbpm.globals.updatenoticeHandlerPos(endPos,name.length+3,0);//更新处理人位置
					//更新选中人数
					var isExit = false;
					for(var j=0; j<lbpm.noticeHandlers.length; j++){
						if(lbpm.noticeHandlers[j].id === id){
							//存在
							isExit = true;
							break;
						}
					}
					if(!isExit){
						lbpm.noticeHanlerNum -= 1;
						$('#noticeHandlerNum').text(lbpm.noticeHanlerNum);
					}
					fdUsageContent.setSelectionRange(startPos,startPos);
					break;
				}
			}
		}
		if(delEndPos){
			if(isDel){
				//删除元素
				var newNoticeHandlers = [];
				for(var i=0; i<lbpm.noticeHandlers.length; i++){
					if(delHandlersIndex.indexOf(i+'') == -1){
						newNoticeHandlers.push(lbpm.noticeHandlers[i]);
					}
				}
				lbpm.noticeHandlers = newNoticeHandlers;
				//选中删除进行信息更新
				var leftStr,rightStr;
				if(rangeStartPos == 0 || rangeStartPos){
					leftStr = content.substring(0, rangeStartPos);
					fdUsageContent.setSelectionRange(rangeStartPos,rangeStartPos);
				}else{
					leftStr = content.substring(0, delStartPos);
					fdUsageContent.setSelectionRange(delStartPos,delStartPos);
				}
				if(rangeEndPos == 0 || rangeEndPos){
					rightStr = content.substring(rangeEndPos);
					var len = content.length - leftStr.length - rightStr.length;
					lbpm.globals.updatenoticeHandlerPos(rangeEndPos,len,0);//更新处理人位置
				}else{
					rightStr = content.substring(delEndPos);
					var len = content.length - leftStr.length - rightStr.length;
					lbpm.globals.updatenoticeHandlerPos(delEndPos,len,0);//更新处理人位置
				}
				fdUsageContent.value = leftStr + rightStr;
				lbpm.noticeAuditNote = leftStr + rightStr;
			}else{//普通删除
				var leftStr = content.substring(0, delStartPos);
				var rightStr = content.substring(delEndPos);
				var len = content.length - leftStr.length - rightStr.length;
				lbpm.globals.updatenoticeHandlerPos(delEndPos,len,0);//更新处理人位置
			}
		}else{
			if(!isDel){//普通删除
				lbpm.globals.updatenoticeHandlerPos(delStartPos,1,0);//更新处理人位置
			}
		}
	}
	lbpm.noticeAuditNote = fdUsageContent.value;
}

//更新处理人的位置
lbpm.globals.updatenoticeHandlerPos = function(pos, len, type){
	if(lbpm.noticeHandlers){
		for(var i=0; i<lbpm.noticeHandlers.length; i++){
			var handler = lbpm.noticeHandlers[i];
			var startPos = handler.startPos;
			var endPos = handler.endPos;
			if(type == 0){
				//减法
				if(startPos >= pos){
					handler.startPos -= len;
					handler.endPos -= len;
				}
			}else{
				//加法
				if(startPos >= (pos-len)){
					handler.startPos += len;
					handler.endPos += len;
				}
			}
		}
	}
}

//更新选择
lbpm.globals.updatenoticeHandlerNum = function(handlers){
	//更新选择的人数
	if(handlers && Object.prototype.toString.call(handlers) === '[object Array]'){
		if(lbpm.noticeHandlers){
			var noticeHandlers = lbpm.noticeHandlers;
			for(var i=0; i<handlers.length; i++){
				var newHandler = handlers[i];
				var isNew = true;
				for(var j=0; j<lbpm.noticeHandlers.length; j++){
					var handler = lbpm.noticeHandlers[j];
					if(handler.id === newHandler.id){
						isNew = false;
						break;
					}
				}
				if(isNew){
					//noticeHandlers.push(newHandler);
					lbpm.noticeHanlerNum += 1;
				}
				noticeHandlers.push(newHandler);
			}
			lbpm.noticeHandlers = noticeHandlers;
		}else{
			//第一次选择
			lbpm.noticeHandlers = [];
			lbpm.noticeHanlerNum = 0;
			var ids = "";
			for(var i=0; i<handlers.length; i++){
				lbpm.noticeHandlers.push(handlers[i]);
				if(ids.indexOf(handlers[i].id) == -1){
					lbpm.noticeHanlerNum += 1;
					ids+=handlers[i].id+";";
				}
			}
		}
		//选择的人数
		$('span.noticeHandlerNum').text(lbpm.noticeHanlerNum);
	}
}

//更新总数
lbpm.globals.updatenoticeHandlerTotal = function(){
	//总数
	var data = new KMSSData();
	var processId = lbpm.modelId;
	data.AddBeanData('noticeHistoryHandlersService&processId='+processId+'&type=count');
	var rtnVal = data.GetHashMapArray()[0];
	if(rtnVal){
		//每次都更新总数
		lbpm.noticeHandlerTotal = parseInt(rtnVal.count);
	}else{
		lbpm.noticeHandlerTotal = 0;
	}
	$('span.noticeHandlerTotal').text(lbpm.noticeHandlerTotal);
}

//更新所有的已处理人
lbpm.globals.updatenoticeHandlers = function(){
	//总数
	var data = new KMSSData();
	var processId = lbpm.modelId;
	data.AddBeanData('noticeHistoryHandlersService&processId='+processId);
	var rtnVal = data.GetHashMapArray();
	var handlersObj = [];
	for(var i=0; i<rtnVal.length; i++){
		var handlerObj = {};
		handlerObj.id = rtnVal[i].id;
		handlerObj.name = rtnVal[i].name;
		handlersObj.push(handlerObj);
	}
	lbpm.allNoticeHandlers = handlersObj;
}

//判断是否为历史处理人
lbpm.globals.isNoticeHandler = function(name){
	if(lbpm.allNoticeHandlers){
		for(var i=0; i<lbpm.allNoticeHandlers.length; i++){
			if(lbpm.allNoticeHandlers[i].name === name){
				return true;
			}
		}
	}
	return false;
}

//检测输入是否在处理人中间，也就是破坏了处理人的格式，这时候删除处理人数据，将其变成普通字符串
lbpm.globals.changeNoticeHandlerToStr = function(pos){
	if(lbpm.noticeHandlers){
		var newNoticeHandlers = [];
		for(var i=0; i<lbpm.noticeHandlers.length; i++){
			var handler = lbpm.noticeHandlers[i];
			var startPos = parseInt(handler.startPos);
			var endPos = parseInt(handler.endPos);
			if(!(pos > startPos && pos < endPos)){//输入在处理人中间，将该处理人变成字符串
				newNoticeHandlers.push(handler);
			}
		}
		lbpm.noticeHandlers = newNoticeHandlers;
	}
}

//全角转半角
function ToCDB(str) {
    var tmp = "";
    for (var i = 0; i < str.length; i++) {
      if (str.charCodeAt(i) > 65248 && str.charCodeAt(i) < 65375) {
        tmp += String.fromCharCode(str.charCodeAt(i) - 65248);
      }
      else {
        tmp += String.fromCharCode(str.charCodeAt(i));
      }
    }
    return tmp
 }


//设置即将流向处理人
lbpm.globals.setHandlerInfoes=function(handlerSelectType){
	var handlerIdsObj;
	var handlerNamesObj;
	var handlerShowNames;

	if(!lbpm.nowNodeId){
		return;
	}
	handlerIdsObj = document.getElementsByName("handlerIds")[0];
	if(!handlerIdsObj){
		return;
	}

	handlerNamesObj = document.getElementsByName("handlerNames")[0];
	handlerShowNames = document.getElementById("handlerShowNames");
	handlerShowNames.innerHTML = handlerNamesObj.value;

	// 取当前节点的下一个节点ID
	var currentNodeObj=lbpm.globals.getCurrentNodeObj();
	var nextNodeObj=lbpm.globals.getNextNodeObj(currentNodeObj.id);
	nextNodeObj.handlerIds = handlerIdsObj.value;
	nextNodeObj.handlerNames = handlerNamesObj.value;
   
	if(handlerSelectType!=null){
		nextNodeObj.handlerSelectType =handlerSelectType;
	}

	//返回json对象
	var rtnNodesMapJSON= new Array();
	rtnNodesMapJSON.push({
		id:nextNodeObj.id,
		handlerIds:nextNodeObj.handlerIds,
		handlerNames:nextNodeObj.handlerNames
	});
	var param={};
	param.nodeInfos=rtnNodesMapJSON;
	lbpm.events.fireListener(lbpm.constant.EVENT_MODIFYNODEATTRIBUTE,param);
};
/**
 * 功能：判断当前用户是否有修改下一节点处理人的权限（即将流向栏出现：从组织架构选择　从备选列表中选择　使用公式定义器）
 * @param nextNodeId 下一个节点的编号如N1,N2
 */
lbpm.globals.checkModifyNextNodeAuthorization=function(nextNodeId){
	if(lbpm.nowNodeId == null){
		return false;
	}
	if(lbpm.nodes[nextNodeId] && lbpm.nodes[nextNodeId].XMLNODENAME == "embeddedSubFlowNode"){
		return false;
	}	
	var currentNodeObj = lbpm.globals.getCurrentNodeObj();
	if(currentNodeObj.canModifyHandlerNodeIds != null && currentNodeObj.canModifyHandlerNodeIds != ""){
		var index = (currentNodeObj.canModifyHandlerNodeIds + ";").indexOf(nextNodeId + ";");
		if(index != -1){
			return true;
		}
	}
	if(currentNodeObj.mustModifyHandlerNodeIds != null && currentNodeObj.mustModifyHandlerNodeIds != ""){
		var index = (currentNodeObj.mustModifyHandlerNodeIds + ";").indexOf(nextNodeId + ";");
		if(index != -1){
			return true;
		}
	}

	return false;
};
 
 /**
  * 功能：展示当前节点的帮助信息
  */
lbpm.globals.getCurrentNodeDescription=function(){
 	var currentNodeObj = lbpm.globals.getCurrentNodeObj();
 	if(currentNodeObj && currentNodeObj.description && (lbpm.constant.ROLETYPE=='' || lbpm.constant.ROLETYPE==lbpm.constant.PROCESSORROLETYPE)){
 		//var description = currentNodeObj.description;
		var description = WorkFlow_getLangLabel(currentNodeObj.description,currentNodeObj["langs"],"nodeDesc");
		var re=/\[url=([^\]]+)\]([^\[]*)\[\/url\]/ig;
		description = description.replace(re,function($0,$1,$2){
				if($2){
					return '<span><a href='+$1+' target=_blank>'+$2+'</a></span>';
				}
				else{
					//没有输入链接描述时 链接地址即为描述
				  return '<span><a href='+$1+' target=_blank>'+$1+'</a></span>';
				}
			});
		//description="<pre>"+description+"</pre>";
		description=description.replace(/\r\n/ig,"<br/>").replace(/\n/ig,"<br/>").replace(/<pre>|<\/pre>/ig,"");
		if(description.indexOf("<a href=") != -1 && description.indexOf("script") != -1){
			description=description.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
		}
 		$("#currentNodeDescription").html(description);
 		$("#currentNodeDescription").css("word-break","break-all");
 		$("#nodeDescriptionDiv").show();
 		if(Com_Parameter.dingXForm === "true"){
			$("#descriptionRow").after($("#nodeDescriptionDiv"));
			$("#nodeDescriptionDiv").addClass("top");
		}
 		if(lbpm.approveType == "right" && lbpm.constant.ISINIT){
 			$("#manualBranchNodeRow").before($("#nodeDescriptionDiv"));
 			$("#nodeDescriptionDiv").addClass("top");
 		}
 	} else {
 		$("#currentNodeDescription").html("");
 		$("#nodeDescriptionDiv").hide();
 	}
 };
 /**
  * 功能：当前用户有多个事务时，切换事务函数
  * @param selectObj 当一个用户有多个工作项，处理事务一栏的多个事务的下拉框对象
  * @param inInit 标识是否是初始加载，区别于用户的手工切换事务
  */
  lbpm.globals.operationItemsChanged=function(selectObj,isInit){
	if(selectObj){
		lbpm.nowProcessorInfoObj=lbpm.processorInfoObj[selectObj.selectedIndex];
	}
 	//var operatorInfo = lbpm.globals.analysisProcessorInfoToObject();
	//获取当前节点ID(指当前人所处的节点，当不是处理人，lbpm.nowNodeId不存在)
	var operatorInfo = lbpm.nowProcessorInfoObj;
	lbpm.nowNodeId=operatorInfo.nodeId;
	lbpm.globals.handlerOperationClearOperationsRow();
 	lbpm.globals.createOperationMethodGroups();
 	setTimeout(function(){
 		if(lbpm.globals.checkModifyAuthorization)
 	 		lbpm.globals.checkModifyAuthorization(lbpm.nowNodeId);
 	 	if(lbpm.globals.initialWorkitemParams){
 	 		lbpm.globals.initialWorkitemParams();
 	 	}
 	 	//初始化意见
 		var saveedArr=WorkFlow_LoadXMLData($("input[name='sysWfBusinessForm.fdCurNodeSavedXML']")[0].value);
 		if(saveedArr.tasks && saveedArr.tasks.length>0){
 			var tasksArr=$.grep(saveedArr.tasks,function(n,i){
 				 return n.id==operatorInfo.id;
 			});
 			if(tasksArr.length>0){
 				var usageContent=lbpm.operations.getfdUsageContent();			
 				if(usageContent) {
 					usageContent.value=lbpm.globals.htmlUnEscape(tasksArr[0].data);
 					//加载@处理人信息
 					lbpm.globals.initNoticeHandlersDataAction();
 				}
 			}
 		}
 		if(!isInit){
 			lbpm.events.fireListener(lbpm.constant.EVENT_CHANGEWORKITEM,null);
 			lbpm.events.fireListener("updateShowLimitTimeOperation",null);
 		}
 	},100);
 };
 /**
  * 更新是否显示限时
  */
 lbpm.globals.updateShowLimitTimeOperation = function(){
	 if(!lbpm.nowProcessorInfoObj){
		 return;
	 }
	 //var taskId = lbpm.nowProcessorInfoObj.id;
	 var nodeFactId = lbpm.nowProcessorInfoObj.nodeId;
	 var processId = lbpm.modelId;
	 var type = lbpm.nowProcessorInfoObj.type;
	 var beanName = "lbpmProcessLimitTimeOperationLogService&processId="+processId+"&nodeFactId="+nodeFactId+"&type="+type;
	 var rtnVal = new KMSSData().AddBeanData(beanName).GetHashMapArray()[0];
	 if(rtnVal && rtnVal.status){
		 var status = parseInt(rtnVal.status);
		 var title;
		 if(status == 0){//超时
			 title = Data_GetResourceString("sys-lbpmservice:lbpmNode.processingNode.timeoutRow");
		 }else if(status == 1){
			 title = Data_GetResourceString("sys-lbpmservice:lbpmNode.processingNode.limitTimeRow");
		 }else{
			 $("#limitTimeRow").hide();
		 }
		 if(status == 0 || status == 1){
			 var detail = '<span class="limit_time_span" style="border-radius: 2px; padding: 2px 7px;">'+rtnVal.day+'</span> '+Data_GetResourceString("sys-lbpmservice:FlowChartObject.Lang.Node.day")+' <span class="limit_time_span" style="border-radius: 2px; padding: 2px 7px;">'+rtnVal.hour+'</span> '+Data_GetResourceString("sys-lbpmservice:FlowChartObject.Lang.Node.hour")+' <span class="limit_time_span" style="border-radius: 2px; padding: 2px 7px;">'+rtnVal.minute+'</span> '+Data_GetResourceString("sys-lbpmservice:FlowChartObject.Lang.Node.minute")+' <span class="limit_time_span" style="border-radius: 2px; padding: 2px 7px;">'+rtnVal.second+'</span> '+Data_GetResourceString("sys-lbpmservice:FlowChartObject.Lang.Node.second");
			 if(lbpm.approveType=="right"){//右侧模式
				 var html = title +" "+ detail;
				 $("#limitTimeRow .lui-lbpm-titleNode").html(html);
			 }else{
				 var html = '<td class="td_normal_title" width="15%">'+title+'</td>';
				 html += '<td colspan="3">'+detail+'</td>';
				 $("#limitTimeRow").html(html);
			 }
			 $("#limitTimeRow").show();
		 }
	 }else{
		 $("#limitTimeRow").hide();
	 }
 }

 
//获取操作类型对应的自定义名称
 lbpm.globals.customizeUsageName= function(operationType){
 	var customizeUsage={};
 	if(operationType=='handler_pass'){
		customizeUsage={"handlerContent":"customizeUsageContent","isRequired":"isPassContentRequired","isValidated":"isPassContentValidated"};
	}
	
	if(operationType=='handler_commission'){
		customizeUsage={"handlerContent":"customizeUsageContentCommission","isRequired":"isCommissionContentRequired","isValidated":"isCommissionContentValidated"};
	}
	
	if(operationType=='handler_nodeSuspend'){
		customizeUsage={"handlerContent":"customizeUsageContentNodeSuspend","isRequired":"isNodeSuspendContentRequired","isValidated":"isNodeSuspendContentValidated"};
	}
	
	if(operationType=='handler_communicate'){
		customizeUsage={"handlerContent":"customizeUsageContentCommunicate","isRequired":"isCommunicateContentRequired","isValidated":"isCommunicateContentValidated"};
	}
	
	if(operationType=='handler_refuse'){
		customizeUsage={"handlerContent":"customizeUsageContentRefuse","isRequired":"isRefuseContentRequired","isValidated":"isRefuseContentValidated"};
	}
	
	if(operationType=='handler_additionSign'){
		customizeUsage={"handlerContent":"customizeUsageContentAdditionSign","isRequired":"isAdditionSignContentRequired","isValidated":"isAdditionSignContentValidated"};
	}
	
	if(operationType=='handler_superRefuse'){
		customizeUsage={"handlerContent":"customizeUsageContentSuperRefuse","isRequired":"isSuperRefuseContentRequired","isValidated":"isSuperRefuseContentValidated"};
	}
	
	if(operationType=='handler_nodeResume'){
		customizeUsage={"handlerContent":"customizeUsageContentNodeResume","isRequired":"isNodeResumeContentRequired","isValidated":"isNodeResumeContentValidated"};
	}
	
	if(operationType=='handler_assign'){
		customizeUsage={"handlerContent":"customizeUsageContentAssign","isRequired":"isAssignContentRequired","isValidated":"isAssignContentValidated"};
	}
	if(operationType=='handler_assignPass'){
		customizeUsage={"handlerContent":"customizeUsageContentAssignPass","isRequired":"isAssignPassContentRequired","isValidated":"isAssignPassContentValidated"};
	}
	if(operationType=='handler_assignRefuse'){
		customizeUsage={"handlerContent":"customizeUsageContentAssignRefuse","isRequired":"isAssignRefuseContentRequired","isValidated":"isAssignRefuseContentValidated"};
	}
	
	if(operationType=='handler_abandon'){
		customizeUsage={"handlerContent":"customizeUsageContentAandon","isRequired":"isAbandonContentRequired","isValidated":"isAbandonContentValidated"};
	}
	
	if(operationType=='handler_sign'){
		customizeUsage={"handlerContent":"customizeUsageContentSign","isRequired":"isSignContentRequired","isValidated":"isSignContentValidated"};
	}
	
	
	return customizeUsage;
 }
 
 
 /**
  * @param obj 操作栏的操作的单选框对象
  * 功能：操作单击事件
  */
lbpm.globals.clickOperation=function(obj)
{
 	var valueAndName = (typeof(obj)=="string"?obj:obj.value).split(":");
 	if (!valueAndName) return;
 	var oprValue = valueAndName[0];
 	var oldOpt = lbpm.currentOperationType;
 	if (oldOpt) {
 		var oldClass = lbpm.operations[oldOpt];
 		if (oldClass && oldClass.blur)
 			oldClass.blur();
 	}
 	var oprClass=lbpm.operations[oprValue];
 	lbpm.globals.handlerOperationClearOperationsRow();
 	oprClass.click(valueAndName[1], obj);
	//隐藏即将流向
	if(oprClass.isHideOperationsRow && lbpm.canHideNextNodeTr && Lbpm_SettingInfo.isHideOperationsRow == "true"){
		var operationsRow = document.getElementById("operationsRow");
		var nextNodeTD = document.getElementById("nextNodeTD");
		lbpm.globals.hiddenObject(operationsRow, true);
		if(nextNodeTD){
			lbpm.globals.hiddenObject(nextNodeTD.parentNode, true);
		}
	}

 	// 设置当前操作是哪个
	lbpm.currentOperationType=oprValue;
	lbpm.events.fireListener(lbpm.constant.EVENT_CHANGEOPERATION,lbpm.currentOperationType);
	// 根据当前操作类型，判断是否显示审批意见必填星号提示
	var lbpmCustomizeFlag=null;
	var extAttributes=lbpm.nodes[lbpm.nowNodeId].extAttributes;
	if(extAttributes){//查看扩展属性值
		for(var i=0;i<extAttributes.length;i++){
			if(extAttributes[i]["name"]=="lbpmCustomizeContentJson"){
				
				var lbpmCustomizeContentJsonStr=extAttributes[i]["value"];
				
				if(lbpmCustomizeContentJsonStr){
					var lbpmCustomizeContentJson=JSON.parse(lbpmCustomizeContentJsonStr);
					var customizeUsageName=null;
					
					//根据操作类型得到相应的默认操作变量
					customizeUsageName=lbpm.globals.customizeUsageName(lbpm.currentOperationType);
					
					if(customizeUsageName){
						if(lbpmCustomizeContentJson[customizeUsageName.isRequired]=="true"){
							lbpmCustomizeFlag="true";
						}else if(lbpmCustomizeContentJson[customizeUsageName.isRequired]=="false"){
							lbpmCustomizeFlag="false";
						}
					}
				}
				break;
			}
		}
	}
	var mustSignStar = document.getElementById("mustSignStar");
	if(mustSignStar){
		if(lbpmCustomizeFlag){
			if(lbpmCustomizeFlag=="true"){
				mustSignStar.style.display = "";
				return;
			}else if(lbpmCustomizeFlag=="false"){
				mustSignStar.style.display = "none";
				return;
			}
		}
 	}
	
	
 	
 	if(mustSignStar){
 		if(lbpm.workitem.constant.COMMONHANDLERUSAGECONTENTDEFAULT_ISREQUIRED[lbpm.currentOperationType]=="true"){
 	 		mustSignStar.style.display = "";
 	 	} else {
 	 		mustSignStar.style.display = "none";
 	 	}
 	}
};

/**
 * @param obj 修改当前处理人的修改模式单选框对象
 * 功能：操作单击事件
 */
lbpm.globals.clickChangeCurHandlerType=function(obj)
{
	var param=lbpm.globals.getOperationParameterJson("curHandlers");
	if(obj.value == 'replace'){
		//构建当前处理人行
		var curHandlerHTML = [];
		for ( var i = 0; i < param.length; i++) {
			curHandlerHTML.push('<label class="lui-lbpm-checkbox"><input type="checkbox" name="curHandlers" checked value="'
							+ param[i].value
							+ '" username="'+param[i].name+'"><span class="checkbox-label">'
							+ param[i].name + '</span></label>');
		}
		$("#operationsTDTitle").html(Data_GetResourceString('sys-lbpmservice:lbpmNode.processingNode.operationsTDTitle.adminOperationTypeChgCurHandler'));
		$("#operationsTDContent").html(curHandlerHTML.join(''));
		$("#operationsRow").show();
		$("#operationsTDTitle_Scope").html(Data_GetResourceString('sys-lbpmservice:lbpmNode.processingNode.operationsTDTitle.adminOperationTypeRepCurHandler'));
	}else{
		//隐藏当前处理人行,且选中所有
		$("#operationsRow").find("input[name='curHandlers']").each(function(){
			$(this).prop('checked',true);
		});
		lbpm.globals.hiddenObject($("#operationsRow")[0], true);
		$("#operationsTDTitle_Scope").html(Data_GetResourceString('sys-lbpmservice:lbpmNode.processingNode.operationsTDTitle.adminOperationTypeApdCurHandler'));
	}
	var exceptValue = [];
	for ( var i = 0; i < param.length; i++) {
		if(obj.value == 'replace'){
			if(!$("#operationsRow").find("input[name='curHandlers'][value="+param[i].value+"]").is(':checked')){
				exceptValue.push(param[i].handlerId);
			}
		}else{
			exceptValue.push(param[i].handlerId);
		}
	}
	var allExpecter=lbpm.globals.getOperationParameterJson("allExpecter");
	for ( var j = 0; j < allExpecter.length; j++) {
		if(!allExpecter[j].isActive){
			exceptValue.push(allExpecter[j].handlerId);
		}
	}
	var handlerIds = "";
	var handlerNames = "";
	var html = "<input type='hidden' name='repHandlerIds' alertText='' value='" + handlerIds + "'><input type='text' name='repHandlerNames' alertText='' readonly class='inputSgl' style='width:70%;' value='" + handlerNames + "'>";
	html += '<a href="javascript:void(0)"';
	if(lbpm.nowProcessorInfoObj && lbpm.nowProcessorInfoObj.type=="shareReviewNode"){
		// 微审批节点处理人选择控制
		html += ' onclick="Com_EventPreventDefault();Dialog_Address(false, \'repHandlerIds\',\'repHandlerNames\', \';\', ORG_TYPE_PERSON, null, null, null, null, null , null,'+JSON.stringify(exceptValue).replace(/\"/g,"'")+');"';
	}else{
		html += ' onclick="Com_EventPreventDefault();Dialog_Address(true, \'repHandlerIds\',\'repHandlerNames\', \';\', ORG_TYPE_PERSON|ORG_TYPE_POST, null, null, null, null, null , null,'+JSON.stringify(exceptValue).replace(/\"/g,"'")+');"';
	}
	html += '>'+Data_GetResourceString('dialog.selectOrg');
	html += '</a>';
	html += "&nbsp;<span class='txtstrong'>*</span>";
	$("#operationsTDContent_Scope").html(html);
};

 /*
  * @param obj 对象、也可以是字符串
  * @param key 如果此参数为null ,取obj对象的key属性
  * @param root 根JSON对象
  * @param saveObj 把解析出来的json字符保存的对象，默认为sysWfBusinessForm.fdParameterJson
  * 设置工作项参数的JSON字符串
  */
 lbpm.globals.setOperationParameterJson=function(obj,key,root,saveObj){
	 if(obj == null) {
		 return;
	 }
	 var jsonObj, objValue;
	 if(saveObj){
		 if(typeof(saveObj) == "string") {
			 if (saveObj == '') {
				 jsonObj = null;
			 } else {
				 jsonObj = $.parseJSON(saveObj);
			 }
		 }
		 else {
			 if (saveObj == null || saveObj.value == '') {
				 jsonObj = null;
			 } else {
				 jsonObj = $.parseJSON(saveObj.value);
			 }
		 }
	 } else {
		 saveObj = $("input[name='sysWfBusinessForm.fdParameterJson']")[0];
		 if (saveObj == null || saveObj.value == '') {
			 jsonObj = null;
		 } else {
			 jsonObj = $.parseJSON(saveObj.value);
		 }
	 }
	 
	 if(!jsonObj) 
		 jsonObj = {};
	 if(obj==null){
		 objValue=null;
	 } else if(typeof(obj)=="object"){
		 var qobj = $(obj);
		 key = key || (qobj.attr('key') ? qobj.attr('key') : qobj.attr('name'));
		 if(obj.type == "checkbox"){
			 objValue = obj.checked;
		 }else if(obj.type == "select-one"){
			 if (obj.options.length > 0) {
				 objValue = obj.options[obj.selectedIndex].value;
			 } else {
				 objValue = '';
			 }
		 } else{
			 objValue = obj.value;
		 }
	 }else{
		 objValue=obj;
	 }
	 
	 if(key == null){
		 return;
	 }

	if(root){
		var scriptOut="if(!jsonObj."+root+") jsonObj."+root+"=new Object();jsonObj."+root+"."+key+"=objValue;";
		(new Function("jsonObj","objValue",scriptOut))(jsonObj,objValue);
	}	
	else{
		var scriptOut="jsonObj."+key+"=objValue;";
		(new Function("jsonObj","objValue",scriptOut))(jsonObj,objValue);
	}
	if(typeof(saveObj)=="string") 
		saveObj=lbpm.globals.objectToJSONString(jsonObj);
	else
		saveObj.value=lbpm.globals.objectToJSONString(jsonObj);
 };
 
 //获取当前处理人提交身份
lbpm.globals.getRolesSelectObj=function(){
 	var handlerId = "";
	var defaultRole = function() {
 		var handlerIdentityIdsObj = document.getElementById("sysWfBusinessForm.fdHandlerRoleInfoIds");
 		var rolesIdsArray = handlerIdentityIdsObj.value.split(";");
 		return rolesIdsArray[0];
	};
	if (window.dijit) {
		var rolesSelectObj = dijit.registry.byId('rolesSelectObj');
		if (!rolesSelectObj) {
			return defaultRole();
		}
		handlerId = rolesSelectObj.get('value');
		if (handlerId != null && handlerId != '') {
			return handlerId;
		}
		return defaultRole();
	}
 	var rolesSelectObj = document.getElementsByName("rolesSelectObj")[0];
 	if(rolesSelectObj != null && rolesSelectObj.selectedIndex > -1){
 		handlerId = rolesSelectObj.options[rolesSelectObj.selectedIndex].value;
 	}else{
 		handlerId = defaultRole();
 	}
 	return handlerId;
};
lbpm.globals.validateMustSignYourSuggestion = function() {
	var flag = false;
	lbpm.events.fireListener(lbpm.constant.EVENT_validateMustSignYourSuggestion, null, function(result){
		if(result){
			flag = true;
		}
	});
	if(!flag) {
		alert(lbpm.constant.opt.MustSignYourSuggestion);
		if(lbpm.approveType == "right"){
			var $spreadBtn = $('#spreadBtn');
			if($spreadBtn.hasClass('spread')){
				$spreadBtn.click();
			}
		}
		return false;
	}
	return true;
};

lbpm.onLoadEvents.delay.push( function() {
	lbpm.events.addListener(lbpm.constant.EVENT_validateMustSignYourSuggestion,function() {
		var fdContentObj=lbpm.operations.getfdUsageContent();
		if(fdContentObj && $.trim(fdContentObj.value) != ""){
			return true;
		}
		return false;
	});
});
lbpm.onLoadEvents.delay.push(function() {
	if(window.$KMSSValidation && typeof window.$KMSSValidation == "function"){ 
		window.$KMSSValidation().addValidator('fdUsageContentMaxLength(length)', lbpm.constant.ERROR_FDUSAGECONTENT_MAXLENGTH,
			function(v, e, o) {// 参数说明 v:Dom对象的值，e：Dom对象，o：参数对象
				var length = isNaN(o['length']) ? 0 : parseInt(o['length']);
				if (length == 0 || this.getValidator('isEmpty').test(v)) return true;
				o['maxLength'] = length;
				var newvalue = v.replace(/[^\x00-\xff]/g, "***");
				return newvalue.length <= length;
			});
	}
	//表单审批意见框绑定事件，比流程先，避免意见内容出错
	var $textareaNotes = $("textarea[name^='textareaNote_']");
	for(var i=0; i<$textareaNotes.length; i++){//一般情况只有一个审批控件
		var textareaNote = $textareaNotes[i];
		var tagId = $(textareaNote).attr("tagid");
		var name = $(textareaNote).attr("name");
		if(tagId && name.indexOf(tagId) != -1){
			//存在意见控件，进行事件绑定
			lbpm.globals.initEvent(textareaNote);
		}
	}
	//流程审批意见框绑定事件
	if(lbpm.operations.getfdUsageContent && lbpm.operations.getfdUsageContent()){
		var fdUsageContent = lbpm.operations.getfdUsageContent();
		lbpm.globals.initEvent(fdUsageContent);
		//绑定失去焦点事件
		$(fdUsageContent).blur(function(){
			var $textareaNotes = $("textarea[name^='textareaNote_']");
			for(var i=0; i<$textareaNotes.length; i++){//一般情况只有一个审批控件
				var textareaNote = $textareaNotes[i];
				var tagId = $(textareaNote).attr("tagid");
				var name = $(textareaNote).attr("name");
				if(tagId && name.indexOf(tagId) != -1){
					//存在意见控件，进行同步
					$(textareaNote).val($(this).val());
				}
			}
		})
	}
});
var isInput = false;
lbpm.globals.initEvent = function(target){
	//初始化@处理人的总数
	lbpm.noticeAuditNote = "";
	var runNum = 0;
	var num = setInterval(function(){
		lbpm.noticeAuditNote = target.value;
		if(runNum >= 15){//最多执行15次
			clearInterval(num);
		}else{
			if(lbpm.noticeAuditNote){
				clearInterval(num);
			}else{
				runNum ++;
			}
		}
	}, 200);
	$(target).bind('compositionstart', function(event){
		isInput = true;
	})
	$(target).bind('compositionend', function(event){
		isInput = false;
	})
	//监听输入事件
	$(target).bind('input propertychange', function(event){
		event.preventDefault();
		event.stopPropagation();
		var obj = this;
		setTimeout(function(){
			//if(!isInput){
				if(lbpm.noticeAuditNote.length > $(obj).val().length){
					var startPos, endPos;
					if(document.selection){//IE
						var sel = document.selection.createRange();
						var selText = document.selection.createRange().text;
						// 获取选区的开始位置
						obj.focus();
						sel.moveStart('character', -obj.value.length); // 移动开始点到最左边位置
					    startPos = sel.text.length; 
			            // 获取选区的结束位置
			            endPos = obj.selectionStart + (lbpm.noticeAuditNote.length - $(obj).val().length);
					}else{
						// 获取选区的开始位置
						startPos = obj.selectionStart;
			            // 获取选区的结束位置
			            endPos = obj.selectionStart + (lbpm.noticeAuditNote.length - $(obj).val().length);
					}
					//根据位置遍历匹配
					var delContent;
					if(startPos+1 == endPos){//删除一个
						lbpm.globals.delNoticeHandler(obj,startPos,null,lbpm.noticeAuditNote.substring(startPos,endPos));
					}else{//选中删除
						lbpm.globals.delNoticeHandler(obj,startPos,endPos,lbpm.noticeAuditNote.substring(startPos,endPos));
					}
				}else if(lbpm.noticeAuditNote.length < $(obj).val().length){
					if (document.selection) {//IE
						obj.focus();
						var sel = document.selection.createRange();
						sel.moveStart('character', -$(obj).val().length); // 移动开始点到最左边位置
						var pos = sel.text.length; 
						var len = $(obj).val().length - lbpm.noticeAuditNote.length || 1;
						lbpm.globals.changeNoticeHandlerToStr(pos-len);
						lbpm.globals.updatenoticeHandlerPos(pos, len);
						lbpm.noticeAuditNote = $(obj).val();
					}else if(typeof target.selectionStart === 'number' && typeof target.selectionEnd === 'number'){
						obj.focus();
						var pos = obj.selectionStart;
						var len = $(obj).val().length - lbpm.noticeAuditNote.length || 1;
						lbpm.globals.changeNoticeHandlerToStr(pos-len);
						lbpm.globals.updatenoticeHandlerPos(pos, len);
						lbpm.noticeAuditNote = $(obj).val();
					}
				}
			//}
		},100);
	})
}

/*
 * 根据组织架构的配置获取处理人角色的名称，组织架构的配置主要是控制部门的路径展示
 * 暂时用于构建提交人身份
 */
lbpm.globals.getHandlerRoleInfoNamesByOrgConfig = function(handlerRoleInfoIds){
	if(!handlerRoleInfoIds){
		return null;
	}
	var url = Com_Parameter.ContextPath + 'sys/lbpmservice/support/lbpm_process/lbpmProcess.do?method=getHandlerRoleInfoNamesByOrgConfig&ajax=true';
	var obj = {
		"handlerRoleInfoIds":handlerRoleInfoIds	
	}
	var result;
	var data = new KMSSData();
	data.AddHashMap(obj);
	data.SendToUrl(url, function(http_request) {
		if(http_request.responseText.indexOf("<error>") == -1){
			result = http_request.responseText;
		}
	},false);
	return result;
}

//是否为最后一个处理人
lbpm.globals.isLastHandler = function(){
	if(typeof lbpm.isLastHandler == "undefined" || lbpm.LastHandlernotUseCache){
		//从后台获取标识
		var url = Com_Parameter.ContextPath + 'sys/lbpm/engine/jsonp.jsp';
		var pjson = {
			's_bean' : 'lbpmIsLastHandlerService',
			'processId' : lbpm.modelId,
			'nodeFactId' : lbpm.nowNodeId,
			'_d' : new Date().toString()
		};
		$.ajaxSettings.async = false;
		$.getJSON(url, pjson, function(json) {
			if(json && json.isLastHandler && json.isLastHandler == true)
				lbpm.isLastHandler = true;
			else
				lbpm.isLastHandler = false;
		});
		$.ajaxSettings.async = true;
	}
	return lbpm.isLastHandler;
};